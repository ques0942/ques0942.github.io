<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en-us lang=en-us><head><link href=https://gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta name=generator content="Hugo 0.62.0"><meta name=viewport content="width=device-width,initial-scale=1"><title>[ãƒ¡ãƒ¢]GitHub Actionsã§terraform plan & applyã™ã‚‹ &#183; å¸¸ã«ã„ã¾ã„ã¡</title><meta name=description content><link type=text/css rel=stylesheet href=https://blog.app.melvins-nest.com/css/print.css media=print><link type=text/css rel=stylesheet href=https://blog.app.melvins-nest.com/css/poole.css><link type=text/css rel=stylesheet href=https://blog.app.melvins-nest.com/css/syntax.css><link type=text/css rel=stylesheet href=https://blog.app.melvins-nest.com/css/hyde.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700"><link rel=apple-touch-icon-precomposed sizes=144x144 href=/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/favicon.png></head><body><aside class=sidebar><div class="container sidebar-sticky"><div class=sidebar-about><a href=https://blog.app.melvins-nest.com/><h1>å¸¸ã«ã„ã¾ã„ã¡</h1></a><p class=lead>blog for something</p></div><nav><ul class=sidebar-nav><li><a href=https://blog.app.melvins-nest.com/>Home</a></li></ul></nav><p>&copy; 2020. All rights reserved.</p></div></aside><main class="content container"><div class=post><h1>[ãƒ¡ãƒ¢]GitHub Actionsã§terraform plan & applyã™ã‚‹</h1><time datetime=2020-07-19T05:18:58Z class=post-date>Sun, Jul 19, 2020</time><h1 id=yaml>æœ€çµ‚çš„ãªyaml</h1><div class=highlight><pre style=color:#f8f8f2;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>name: <span style=color:#87ceeb>&#34;terraform&#34;</span>

on:
  push:
    branches:
      - master
  pull_request:
    types: [opened, synchronize, reopened]

env:
  GOOGLE_APPLICATION_CREDENTIALS_KEY: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS_KEY }}
  GOOGLE_APPLICATION_CREDENTIALS: /tmp/credentials.json

jobs:
  terraform:
    name: <span style=color:#87ceeb>&#34;terraform&#34;</span>
    runs-on: <span style=color:#87ceeb>&#34;ubuntu-latest&#34;</span>
    env:
      GOOGLE_APPLICATION_CREDENTIALS: /tmp/credentials.json
    steps:
    - name: checkout
      uses: actions/checkout@v2
    - name: setup terraform
      uses: hashicorp/setup-terraform@v1
    - name: copy credentials
      run: echo ${GOOGLE_APPLICATION_CREDENTIALS_KEY} &gt; ${GOOGLE_APPLICATION_CREDENTIALS}
    - name: init
      id: init
      run: terraform init
    - name: validate
      id: validate
      run: terraform validate -no-color
      continue-on-error: <span style=color:red>true</span>
    - name: format check
      id: fmt
      run: terraform fmt -check -diff
      continue-on-error: <span style=color:red>true</span>
    - name: plan
      id: plan
      run: terraform plan -no-color
      continue-on-error: <span style=color:red>true</span>
    - name: remove old comment
      id: remove_old_comment
      uses: actions/github-script@<span style=color:#f60>0.9</span><span style=color:#f60>.0</span>
      if: github.event_name == <span style=color:#87ceeb>&#39;pull_request&#39;</span>
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: <span style=color:#87ceeb>|
</span><span style=color:#87ceeb>         </span><span style=color:#87ceeb> </span><span style=color:#87ceeb>opts = github.issues.listComments.endpoint.merge({</span>
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            per_page: <span style=color:#f60>100</span>,
          })
          const comments = await github.paginate(opts)
          for(const comment of comments) {
            if (comment.user.login === <span style=color:#87ceeb>&#34;github-actions[bot]&#34;</span> <span style=color:#e5e5e5>&amp;&amp;</span> comment.body.startsWith(<span style=color:#87ceeb>&#34;#### Terraform Format and Style&#34;</span>)) {
              github.issues.deleteComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: comment.id,
              })
            }
          }
    - name: show plan
      uses: actions/github-script@<span style=color:#f60>0.9</span><span style=color:#f60>.0</span>
      if: github.event_name == <span style=color:#87ceeb>&#39;pull_request&#39;</span>
      env:
        PLAN: <span style=color:#87ceeb>&#34;terraform\n${{ steps.plan.outputs.stdout }}&#34;</span>
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: <span style=color:#87ceeb>|
</span><span style=color:#87ceeb>         </span><span style=color:#87ceeb> </span><span style=color:#87ceeb>const output = `#### Terraform Format and Style ğŸ–Œ\`${{ steps.fmt.outcome }}\`</span>
          <span style=color:#0f0>#### Terraform Initialization: \`${{ steps.init.outcome }}\`</span>
          <span style=color:#0f0>#### Terraform Validation: ${{ steps.validate.outputs.stdout }}</span>
          <span style=color:#0f0>#### Terraform Format: ${{ steps.fmt.outputs.stdout }} </span>
          <span style=color:#0f0>#### Terraform Plan: \`${{ steps.plan.outcome }}\`</span>
          &lt;details&gt;&lt;summary&gt;Show Plan&lt;/summary<span style=color:#87ceeb>&gt;
</span><span style=color:#87ceeb>         </span><span style=color:#87ceeb> </span><span style=color:#87ceeb>\`\`\`${process.env.PLAN}\`\`\`</span>
          &lt;/details<span style=color:#87ceeb>&gt;
</span><span style=color:#87ceeb>         </span><span style=color:#87ceeb> </span><span style=color:#87ceeb>*Pusher: @${{ github.actor }}, Action: \`${{ github.event_name }}\`,  Workflow: \`${{ github.workflow }}\`*`;</span>
          github.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: output
          })
    - name: check on failure
      if: steps.validate.outcome == <span style=color:#87ceeb>&#39;failure&#39;</span> || steps.fmt.outcome == <span style=color:#87ceeb>&#39;failure&#39;</span> || steps.plan.outcome == <span style=color:#87ceeb>&#39;failure&#39;</span>
      run: <span style=color:#87ceeb>|
</span><span style=color:#87ceeb>       </span><span style=color:#87ceeb> </span><span style=color:#87ceeb>echo ${{ steps.validate.outputs.status }} </span>
        echo ${{ steps.fmt.outputs.status }}
        echo ${{ steps.plan.outputs.status }}
        exit <span style=color:#f60>1</span>
    - name: apply
      if: github.ref == <span style=color:#87ceeb>&#39;refs/heads/master&#39;</span> <span style=color:#e5e5e5>&amp;&amp;</span> github.event_name == <span style=color:#87ceeb>&#39;push&#39;</span>
      run: terraform apply -auto-approve
</code></pre></div><h1 id=heading>èª¬æ˜</h1><h2 id=action>Actionã‚’ç™ºç«ã•ã›ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆ</h2><div class=highlight><pre style=color:#f8f8f2;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>on:
  push:
    branches:
      - master
  pull_request:
    types: [opened, synchronize, reopened]
</code></pre></div><p>masterã«ãƒãƒ¼ã‚¸ã•ã‚ŒãŸæ™‚ã«terraform applyã—ãŸã„ã®ã§masterã«å¯¾ã™ã‚‹pushã‚¤ãƒ™ãƒ³ãƒˆã‚’ã€
PRãŒä½œæˆã€æ›´æ–°ã•ã‚ŒãŸterraform planã—ãŸã„ã®ã§pull_requestã®open/synchronize/reopenedã‚¤ãƒ™ãƒ³ãƒˆã‚’å¯¾è±¡ã«ã™ã‚‹(å®Ÿéš›ã®ã¨ã“ã‚<a href=https://docs.github.com/en/actions/reference/events-that-trigger-workflows#pull_request>pull_requestã¨ã ã‘æŒ‡å®šã™ã‚Œã°ã“ã®3ã¤ã‚’å¯¾è±¡ã«ã—ãŸã“ã¨ã«ãªã‚‹</a>)
pull_requestã®synchronizeã¯<a href=https://github.community/t/what-is-a-pull-request-synchronize-event/14784>PRã®ã‚½ãƒ¼ã‚¹ãƒ–ãƒ©ãƒ³ãƒãŒæ›´æ–°ã•ã‚ŒãŸã¨ãã«ç™ºè¡Œã•ã‚Œã‚‹</a>ã€‚</p><h2 id=credential>credential</h2><div class=highlight><pre style=color:#f8f8f2;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>env:
  GOOGLE_APPLICATION_CREDENTIALS_KEY: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS_KEY }}
  GOOGLE_APPLICATION_CREDENTIALS: /tmp/credentials.json
</code></pre></div><p>Secretsã«äºˆã‚service accountã®jsonã‚’ç™»éŒ²ã—ã¦ãŠãã€‚
<code>GOOGLE_APPLICATION_CREDENTIALS</code> ã‚’å®šç¾©ã—ã¦ãŠãã¨terraformãŒãã‚Œã‚’èª­ã¿å–ã£ã¦ãã‚Œã‚‹ã®ã§ä»Šå›ã¯ã“ã®æ–¹æ³•ã§credentialã‚’æ¸¡ã™ã“ã¨ã«ã—ãŸã€‚</p><h2 id=workflow>workflowã®èª¬æ˜</h2><h3 id=checkout>checkoutã¾ã§</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>jobs:
  terraform:
    name: <span style=color:#87ceeb>&#34;terraform&#34;</span>
    runs-on: <span style=color:#87ceeb>&#34;ubuntu-latest&#34;</span>
    env:
      GOOGLE_APPLICATION_CREDENTIALS: /tmp/credentials.json
    steps:
    - name: checkout
      uses: actions/checkout@v2
</code></pre></div><p>ã“ã“ã¾ã§ã¯ãƒ†ãƒ³ãƒ—ãƒ¬</p><h3 id=terraform>terraformã®å°å…¥</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>    - name: setup terraform
      uses: hashicorp/setup-terraform@v1
</code></pre></div><p><a href=https://github.com/hashicorp/setup-terraform>Hashicorpå…¬å¼ã®action</a>ãŒã‚ã‚‹ã®ã§ã“ã‚Œã‚’ä½¿ã†ã€‚
terraformã®versionæŒ‡å®šãªã©ã‚‚ã§ãã‚‹ã®ã§å¿…è¦ãªã‚‰è¨­å®šã™ã‚‹ã€‚READMEã«ä½¿ã„æ–¹ã¯å¤§ä½“æ›¸ã„ã¦ã‚ã‚‹ã€‚</p><h3 id=credential-1>credentialã®æ›¸ãå‡ºã—</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>    - name: copy credentials
      run: echo ${GOOGLE_APPLICATION_CREDENTIALS_KEY} &gt; ${GOOGLE_APPLICATION_CREDENTIALS}
</code></pre></div><p><code>GOOGLE_APPLICATION_CREDENTIALS</code> ã§æŒ‡å®šã—ãŸãƒ‘ã‚¹ã«service accountã‚­ãƒ¼ã‚’æ›¸ãå‡ºã—ã¦ãŠãã€‚</p><h3 id=terraformplan>terraformã®å„ç¨®ãƒã‚§ãƒƒã‚¯ã¨planã®å®Ÿè¡Œ</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>    - name: init
      id: init
      run: terraform init
    - name: validate
      id: validate
      run: terraform validate -no-color
      continue-on-error: <span style=color:red>true</span>
    - name: format check
      id: fmt
      run: terraform fmt -check -diff
      continue-on-error: <span style=color:red>true</span>
    - name: plan
      id: plan
      run: terraform plan -no-color
      continue-on-error: <span style=color:red>true</span>
</code></pre></div><p>init/validate/fmt/planã‚’ãã‚Œãã‚Œå®Ÿè¡Œã—ã¦çµæœã‚’åé›†ã™ã‚‹ã€‚
validate/planã§ <code>-no-color</code> ã‚’ã¤ã‘å¿˜ã‚Œã‚‹ã¨å‡ºåŠ›ã«ã‚«ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ãŒå…¥ã‚Šè¾¼ã‚€ã®ã§æ³¨æ„ã€‚</p><p><code>continue-on-error: true</code> ã¨ã—ã¦ã„ã‚‹ã®ã¯å„ç¨®ãƒã‚§ãƒƒã‚¯ã®çµæœã‚’PRã«ã‚³ãƒ¡ãƒ³ãƒˆã¨ã—ã¦æ›¸ãå‡ºã™å‡¦ç†ã‚’è¡Œã†ãŸã‚ã€‚
ã“ã®è¨˜è¿°ã‚’çœãã¨ã„ãšã‚Œã‹ã®ãƒã‚§ãƒƒã‚¯ã§å¤±æ•—ã™ã‚‹ã¨ãã“ã§ä¸­æ–­ã™ã‚‹ã€‚
ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›¸ãå‡ºã™å¿…è¦ãŒãªã‘ã‚Œã°ãã†ã—ã¦ã—ã¾ãˆã°è‰¯ã„ã€‚</p><h3 id=heading-1>å¤ã„ã‚³ãƒ¡ãƒ³ãƒˆã®å‰Šé™¤</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>    - name: remove old comment
      id: remove_old_comment
      uses: actions/github-script@<span style=color:#f60>0.9</span><span style=color:#f60>.0</span>
      if: github.event_name == <span style=color:#87ceeb>&#39;pull_request&#39;</span>
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: <span style=color:#87ceeb>|
</span><span style=color:#87ceeb>         </span><span style=color:#87ceeb> </span><span style=color:#87ceeb>opts = github.issues.listComments.endpoint.merge({</span>
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            per_page: <span style=color:#f60>100</span>,
          })
          const comments = await github.paginate(opts)
          for(const comment of comments) {
            if (comment.user.login === <span style=color:#87ceeb>&#34;github-actions[bot]&#34;</span> <span style=color:#e5e5e5>&amp;&amp;</span> comment.body.startsWith(<span style=color:#87ceeb>&#34;#### Terraform Format and Style&#34;</span>)) {
              github.issues.deleteComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: comment.id,
              })
            }
          }
</code></pre></div><p>ã“ã®actionã‚’è¤‡æ•°å›å®Ÿè¡Œã™ã‚‹ã¨éƒ½åº¦ã‚³ãƒ¡ãƒ³ãƒˆãŒå¢—ãˆã¦ã—ã¾ã†ã®ã§ã€
<a href=https://github.com/actions/github-script>github-script</a>ã‚’ç”¨ã„ã¦å¤ã„ã‚³ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤ã™ã‚‹ã€‚
é€šå¸¸ãã‚“ãªã«ãŸãã•ã‚“ã‚³ãƒ¡ãƒ³ãƒˆãŒä»˜ãã“ã¨ã¯ç„¡ã„ã¨æ€ã†ãŒã€
å¿µã®ç‚ºãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã—ã¦å…¨éƒ¨ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’å–ã‚Šå‡ºã—ã¦ã€github actionsã‹ã‚‰ã¤ã‘ã‚‰ã‚ŒãŸã‚³ãƒ¡ãƒ³ãƒˆã‹ã¤æœ¬æ–‡ãŒã“ã®actionã§ä»˜ä¸ã—ãŸã‚‚ã®ã¨é¡ä¼¼ã™ã‚‹ã‚‚ã®ã‚’å‰Šé™¤ã—ã¦ã„ã‚‹ã€‚</p><p>github-scriptã®ä½¿ã„æ–¹ã¯ã“ã®ã‚ãŸã‚Šã‚’å‚è€ƒã«ã—ãŸã€‚</p><ul><li><a href=https://github.com/actions/github-script#welcome-a-first-time-contributor>https://github.com/actions/github-script#welcome-a-first-time-contributor</a></li><li><a href=https://octokit.github.io/rest.js/>https://octokit.github.io/rest.js/</a></li><li><a href=https://maku.blog/p/7r6gr3d/>https://maku.blog/p/7r6gr3d/</a></li></ul><h3 id=plan>ãƒã‚§ãƒƒã‚¯ã€planã®çµæœã‚’ã‚³ãƒ¡ãƒ³ãƒˆã¨ã—ã¦æ›¸ãå‡ºã™</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>    - name: show plan
      uses: actions/github-script@<span style=color:#f60>0.9</span><span style=color:#f60>.0</span>
      if: github.event_name == <span style=color:#87ceeb>&#39;pull_request&#39;</span>
      env:
        PLAN: <span style=color:#87ceeb>&#34;terraform\n${{ steps.plan.outputs.stdout }}&#34;</span>
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: <span style=color:#87ceeb>|
</span><span style=color:#87ceeb>         </span><span style=color:#87ceeb> </span><span style=color:#87ceeb>const output = `#### Terraform Format and Style ğŸ–Œ\`${{ steps.fmt.outcome }}\`</span>
          <span style=color:#0f0>#### Terraform Initialization: \`${{ steps.init.outcome }}\`</span>
          <span style=color:#0f0>#### Terraform Validation: ${{ steps.validate.outputs.stdout }}</span>
          <span style=color:#0f0>#### Terraform Format: ${{ steps.fmt.outputs.stdout }} </span>
          <span style=color:#0f0>#### Terraform Plan: \`${{ steps.plan.outcome }}\`</span>
          &lt;details&gt;&lt;summary&gt;Show Plan&lt;/summary<span style=color:#87ceeb>&gt;
</span><span style=color:#87ceeb>         </span><span style=color:#87ceeb> </span><span style=color:#87ceeb>\`\`\`${process.env.PLAN}\`\`\`</span>
          &lt;/details<span style=color:#87ceeb>&gt;
</span><span style=color:#87ceeb>         </span><span style=color:#87ceeb> </span><span style=color:#87ceeb>*Pusher: @${{ github.actor }}, Action: \`${{ github.event_name }}\`,  Workflow: \`${{ github.workflow }}\`*`;</span>
          github.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: output
          })
</code></pre></div><p>é©å½“ãªãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã§PRã«ã‚³ãƒ¡ãƒ³ãƒˆã¨ã—ã¦çµæœã‚’æ›¸ãå‡ºã™ã€‚
å½“ç„¶ãªãŒã‚‰æ›¸ãå‡ºã™å…ˆã®PRãŒç„¡ã„ã¨å‹•ã‹ãªã„ã®ã§ã€<code>if</code>ã§event_nameã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦pull_requestã ã‘ã‚’å¯¾è±¡ã«ã™ã‚‹ã€‚</p><h3 id=plan-1>ãƒã‚§ãƒƒã‚¯ã€planã«ä¸å‚™ãŒã‚ã‚‹å ´åˆã¯ã‚¨ãƒ©ãƒ¼çµ‚äº†ã•ã›ã‚‹</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>- name: check on failure
      if: steps.validate.outcome == <span style=color:#87ceeb>&#39;failure&#39;</span> || steps.fmt.outcome == <span style=color:#87ceeb>&#39;failure&#39;</span> || steps.plan.outcome == <span style=color:#87ceeb>&#39;failure&#39;</span>
      run: exit <span style=color:#f60>1</span>
</code></pre></div><p>ä¸å‚™ãŒã‚ã‚‹å ´åˆã¯ãƒãƒ¼ã‚¸ã§ããªã„ã‚ˆã†ã«ã—ãŸã„ã®ã§ã€çµ‚äº†ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ãã‚Œãã‚Œãƒã‚§ãƒƒã‚¯ã—ã¦ã©ã‚Œã‹ä¸€ã¤ã§ã‚‚å¤±æ•—ã—ã¦ã„ãŸã‚‰ã‚¨ãƒ©ãƒ¼çµ‚äº†ã•ã›ã‚‹ã€‚</p><h3 id=terraform-apply>terraform applyã™ã‚‹</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>    - name: apply
      if: github.ref == <span style=color:#87ceeb>&#39;refs/heads/master&#39;</span> <span style=color:#e5e5e5>&amp;&amp;</span> github.event_name == <span style=color:#87ceeb>&#39;push&#39;</span>
      run: terraform apply -auto-approve
</code></pre></div><p>ç„¡äº‹ã«masterã«ãƒãƒ¼ã‚¸ã•ã‚ŒãŸã‚‰applyã—ã¦å¤‰æ›´å†…å®¹ã‚’ã‚¤ãƒ³ãƒ•ãƒ©ã«åæ˜ ã•ã›ã‚‹ã€‚
å®Ÿè¡Œç¢ºèªãŒå‡ºãªã„ã‚ˆã†ã« <code>-auto-approve</code> ã‚’ã¤ã‘ã¦å®Ÿè¡Œã™ã‚‹ã€‚</p></div></main><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-155249985-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></body></html>