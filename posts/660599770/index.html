<!doctype html><html lang=en-us data-theme><head><meta charset=utf-8><meta name=HandheldFriendly content="True"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer-when-downgrade"><title>[ãƒ¡ãƒ¢]GitHub Actionsã§terraform plan & applyã™ã‚‹ - å¸¸ã«ã„ã¾ã„ã¡</title><meta name=description content="blog for something"><link rel=icon type=image/x-icon href=https://blog.app.melvins-nest.com/favicon.ico><link rel=apple-touch-icon-precomposed href=https://blog.app.melvins-nest.com/favicon.png><link rel=stylesheet href="https://blog.app.melvins-nest.com/css/light.css?rnd=1607129636"><style>[data-theme=dark]{--font-color: #eee;--bg-color: #212121;--link-color:#599ada;--link-state-color:#ff5858;--link-state-border-color: rgba(238, 54, 54, 0.5);--thead-bg-color: #343a40;--table-border-color: lightgrey;--pre-color: #333;--pre-bg-color: #f1f1f1;--bq-color: #ccc;--hr-color: #333;--pagination-bg-color: #373737;--pagination-link-color: #b6b6b6;--post-info-color: grey;--switcher-color: #333;--switcher-bg-color: #fff}</style><link rel=stylesheet href="https://blog.app.melvins-nest.com/css/style.css?rnd=1607129636"><meta property="og:title" content="[ãƒ¡ãƒ¢]GitHub Actionsã§terraform plan & applyã™ã‚‹"><meta property="og:description" content="Github Actionsã‚’ä½¿ã£ã¦PRãƒ™ãƒ¼ã‚¹ã§terraform planã‚’æ¤œè¨¼ã—ã€masterãƒãƒ¼ã‚¸ã•ã‚ŒãŸå®šç¾©ã‚’terraform applyã§ã‚¤ãƒ³ãƒ•ãƒ©ã«é©ç”¨ã™ã‚‹ã€‚"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.app.melvins-nest.com/posts/660599770/"><meta property="article:published_time" content="2020-07-19T16:31:55+00:00"><meta property="article:modified_time" content="2020-07-19T16:31:55+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="[ãƒ¡ãƒ¢]GitHub Actionsã§terraform plan & applyã™ã‚‹"><meta name=twitter:description content="Github Actionsã‚’ä½¿ã£ã¦PRãƒ™ãƒ¼ã‚¹ã§terraform planã‚’æ¤œè¨¼ã—ã€masterãƒãƒ¼ã‚¸ã•ã‚ŒãŸå®šç¾©ã‚’terraform applyã§ã‚¤ãƒ³ãƒ•ãƒ©ã«é©ç”¨ã™ã‚‹ã€‚"></head><body><a class=skip-main href=#main>Skip to main content</a><div class=container><header class=common-header><h1 class=site-title><a href=/>å¸¸ã«ã„ã¾ã„ã¡</a></h1><nav></nav></header><main id=main tabindex=-1><article class=post><header class=post-header><h1 class=post-title>[ãƒ¡ãƒ¢]GitHub Actionsã§terraform plan & applyã™ã‚‹</h1></header><div class=content><p>Github Actionsã‚’ä½¿ã£ã¦PRãƒ™ãƒ¼ã‚¹ã§terraform planã‚’æ¤œè¨¼ã—ã€masterãƒãƒ¼ã‚¸ã•ã‚ŒãŸå®šç¾©ã‚’terraform applyã§ã‚¤ãƒ³ãƒ•ãƒ©ã«é©ç”¨ã™ã‚‹ã€‚</p><h1 id=æœ€çµ‚çš„ãªyaml>æœ€çµ‚çš„ãªyaml</h1><div class=highlight><pre style=color:#f8f8f2;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:red>name</span>: <span style=color:#87ceeb>&#34;terraform&#34;</span>

<span style=color:red>on</span>:
  <span style=color:red>push</span>:
    <span style=color:red>branches</span>:
      - master
  <span style=color:red>pull_request</span>:
    <span style=color:red>types</span>: [opened, synchronize, reopened]

<span style=color:red>env</span>:
  <span style=color:red>GOOGLE_APPLICATION_CREDENTIALS_KEY</span>: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS_KEY }}
  <span style=color:red>GOOGLE_APPLICATION_CREDENTIALS</span>: /tmp/credentials.json

<span style=color:red>jobs</span>:
  <span style=color:red>terraform</span>:
    <span style=color:red>name</span>: <span style=color:#87ceeb>&#34;terraform&#34;</span>
    <span style=color:red>runs-on</span>: <span style=color:#87ceeb>&#34;ubuntu-latest&#34;</span>
    <span style=color:red>env</span>:
      <span style=color:red>GOOGLE_APPLICATION_CREDENTIALS</span>: /tmp/credentials.json
    <span style=color:red>steps</span>:
    - <span style=color:red>name</span>: checkout
      <span style=color:red>uses</span>: actions/checkout@v2
    - <span style=color:red>name</span>: setup terraform
      <span style=color:red>uses</span>: hashicorp/setup-terraform@v1
    - <span style=color:red>name</span>: copy credentials
      <span style=color:red>run</span>: echo ${GOOGLE_APPLICATION_CREDENTIALS_KEY} &gt; ${GOOGLE_APPLICATION_CREDENTIALS}
    - <span style=color:red>name</span>: init
      <span style=color:red>id</span>: init
      <span style=color:red>run</span>: terraform init
    - <span style=color:red>name</span>: validate
      <span style=color:red>id</span>: validate
      <span style=color:red>run</span>: terraform validate -no-color
      <span style=color:red>continue-on-error</span>: <span style=color:red>true</span>
    - <span style=color:red>name</span>: format check
      <span style=color:red>id</span>: fmt
      <span style=color:red>run</span>: terraform fmt -check -diff
      <span style=color:red>continue-on-error</span>: <span style=color:red>true</span>
    - <span style=color:red>name</span>: plan
      <span style=color:red>id</span>: plan
      <span style=color:red>run</span>: terraform plan -no-color
      <span style=color:red>continue-on-error</span>: <span style=color:red>true</span>
    - <span style=color:red>name</span>: remove old comment
      <span style=color:red>id</span>: remove_old_comment
      <span style=color:red>uses</span>: actions/github-script@<span style=color:#f60>0.9.0</span>
      <span style=color:red>if</span>: github.event_name == <span style=color:#87ceeb>&#39;pull_request&#39;</span>
      <span style=color:red>with</span>:
        <span style=color:red>github-token</span>: ${{ secrets.GITHUB_TOKEN }}
        <span style=color:red>script</span>: <span style=color:#87ceeb>|
</span><span style=color:#87ceeb>          opts = github.issues.listComments.endpoint.merge({</span>
            <span style=color:red>owner</span>: context.repo.owner,
            <span style=color:red>repo</span>: context.repo.repo,
            <span style=color:red>issue_number</span>: context.issue.number,
            <span style=color:red>per_page</span>: <span style=color:#f60>100</span>,
          })
          const comments = await github.paginate(opts)
          for(const comment of comments) {
            if (comment.user.login === <span style=color:#87ceeb>&#34;github-actions[bot]&#34;</span> <span style=color:#e5e5e5>&amp;&amp;</span> comment.body.startsWith(<span style=color:#87ceeb>&#34;#### Terraform Format and Style&#34;</span>)) {
              github.issues.deleteComment({
                <span style=color:red>owner</span>: context.repo.owner,
                <span style=color:red>repo</span>: context.repo.repo,
                <span style=color:red>comment_id</span>: comment.id,
              })
            }
          }
    - <span style=color:red>name</span>: show plan
      <span style=color:red>uses</span>: actions/github-script@<span style=color:#f60>0.9.0</span>
      <span style=color:red>if</span>: github.event_name == <span style=color:#87ceeb>&#39;pull_request&#39;</span>
      <span style=color:red>env</span>:
        <span style=color:red>PLAN</span>: <span style=color:#87ceeb>&#34;terraform\n${{ steps.plan.outputs.stdout }}&#34;</span>
      <span style=color:red>with</span>:
        <span style=color:red>github-token</span>: ${{ secrets.GITHUB_TOKEN }}
        <span style=color:red>script</span>: <span style=color:#87ceeb>|
</span><span style=color:#87ceeb>          const output = `#### Terraform Format and Style ğŸ–Œ\`${{ steps.fmt.outcome }}\`</span>
          <span style=color:#0f0>#### Terraform Initialization: \`${{ steps.init.outcome }}\`</span>
          <span style=color:#0f0>#### Terraform Validation: ${{ steps.validate.outputs.stdout }}</span>
          <span style=color:#0f0>#### Terraform Format: ${{ steps.fmt.outputs.stdout }} </span>
          <span style=color:#0f0>#### Terraform Plan: \`${{ steps.plan.outcome }}\`</span>
          &lt;details&gt;&lt;summary&gt;Show Plan&lt;/summary<span style=color:#87ceeb>&gt;
</span><span style=color:#87ceeb>          \`\`\`${process.env.PLAN}\`\`\`</span>
          &lt;/details<span style=color:#87ceeb>&gt;
</span><span style=color:#87ceeb>          *Pusher: @${{ github.actor }}, Action: \`${{ github.event_name }}\`,  Workflow: \`${{ github.workflow }}\`*`;</span>
          github.issues.createComment({
            <span style=color:red>issue_number</span>: context.issue.number,
            <span style=color:red>owner</span>: context.repo.owner,
            <span style=color:red>repo</span>: context.repo.repo,
            <span style=color:red>body</span>: output
          })
    - <span style=color:red>name</span>: check on failure
      <span style=color:red>if</span>: steps.validate.outcome == <span style=color:#87ceeb>&#39;failure&#39;</span> || steps.fmt.outcome == <span style=color:#87ceeb>&#39;failure&#39;</span> || steps.plan.outcome == <span style=color:#87ceeb>&#39;failure&#39;</span>
      <span style=color:red>run</span>: <span style=color:#87ceeb>|
</span><span style=color:#87ceeb>        echo ${{ steps.validate.outputs.status }} </span>
        echo ${{ steps.fmt.outputs.status }}
        echo ${{ steps.plan.outputs.status }}
        exit <span style=color:#f60>1</span>
    - <span style=color:red>name</span>: apply
      <span style=color:red>if</span>: github.ref == <span style=color:#87ceeb>&#39;refs/heads/master&#39;</span> <span style=color:#e5e5e5>&amp;&amp;</span> github.event_name == <span style=color:#87ceeb>&#39;push&#39;</span>
      <span style=color:red>run</span>: terraform apply -auto-approve
</code></pre></div><h1 id=èª¬æ˜>èª¬æ˜</h1><h2 id=actionã‚’ç™ºç«ã•ã›ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆ>Actionã‚’ç™ºç«ã•ã›ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆ</h2><div class=highlight><pre style=color:#f8f8f2;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:red>on</span>:
  <span style=color:red>push</span>:
    <span style=color:red>branches</span>:
      - master
  <span style=color:red>pull_request</span>:
    <span style=color:red>types</span>: [opened, synchronize, reopened]
</code></pre></div><p>masterã«ãƒãƒ¼ã‚¸ã•ã‚ŒãŸæ™‚ã«terraform applyã—ãŸã„ã®ã§masterã«å¯¾ã™ã‚‹pushã‚¤ãƒ™ãƒ³ãƒˆã‚’ã€
PRãŒä½œæˆã€æ›´æ–°ã•ã‚ŒãŸterraform planã—ãŸã„ã®ã§pull_requestã®open/synchronize/reopenedã‚¤ãƒ™ãƒ³ãƒˆã‚’å¯¾è±¡ã«ã™ã‚‹(å®Ÿéš›ã®ã¨ã“ã‚<a href=https://docs.github.com/en/actions/reference/events-that-trigger-workflows#pull_request>pull_requestã¨ã ã‘æŒ‡å®šã™ã‚Œã°ã“ã®3ã¤ã‚’å¯¾è±¡ã«ã—ãŸã“ã¨ã«ãªã‚‹</a>)
pull_requestã®synchronizeã¯<a href=https://github.community/t/what-is-a-pull-request-synchronize-event/14784>PRã®ã‚½ãƒ¼ã‚¹ãƒ–ãƒ©ãƒ³ãƒãŒæ›´æ–°ã•ã‚ŒãŸã¨ãã«ç™ºè¡Œã•ã‚Œã‚‹</a>ã€‚</p><h2 id=credential>credential</h2><div class=highlight><pre style=color:#f8f8f2;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:red>env</span>:
  <span style=color:red>GOOGLE_APPLICATION_CREDENTIALS_KEY</span>: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS_KEY }}
  <span style=color:red>GOOGLE_APPLICATION_CREDENTIALS</span>: /tmp/credentials.json
</code></pre></div><p>Secretsã«äºˆã‚service accountã®jsonã‚’ç™»éŒ²ã—ã¦ãŠãã€‚
<code>GOOGLE_APPLICATION_CREDENTIALS</code> ã‚’å®šç¾©ã—ã¦ãŠãã¨terraformãŒãã‚Œã‚’èª­ã¿å–ã£ã¦ãã‚Œã‚‹ã®ã§ä»Šå›ã¯ã“ã®æ–¹æ³•ã§credentialã‚’æ¸¡ã™ã“ã¨ã«ã—ãŸã€‚</p><h2 id=workflowã®èª¬æ˜>workflowã®èª¬æ˜</h2><h3 id=checkoutã¾ã§>checkoutã¾ã§</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:red>jobs</span>:
  <span style=color:red>terraform</span>:
    <span style=color:red>name</span>: <span style=color:#87ceeb>&#34;terraform&#34;</span>
    <span style=color:red>runs-on</span>: <span style=color:#87ceeb>&#34;ubuntu-latest&#34;</span>
    <span style=color:red>env</span>:
      <span style=color:red>GOOGLE_APPLICATION_CREDENTIALS</span>: /tmp/credentials.json
    <span style=color:red>steps</span>:
    - <span style=color:red>name</span>: checkout
      <span style=color:red>uses</span>: actions/checkout@v2
</code></pre></div><p>ã“ã“ã¾ã§ã¯ãƒ†ãƒ³ãƒ—ãƒ¬</p><h3 id=terraformã®å°å…¥>terraformã®å°å…¥</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>    - <span style=color:red>name</span>: setup terraform
      <span style=color:red>uses</span>: hashicorp/setup-terraform@v1
</code></pre></div><p><a href=https://github.com/hashicorp/setup-terraform>Hashicorpå…¬å¼ã®action</a>ãŒã‚ã‚‹ã®ã§ã“ã‚Œã‚’ä½¿ã†ã€‚
terraformã®versionæŒ‡å®šãªã©ã‚‚ã§ãã‚‹ã®ã§å¿…è¦ãªã‚‰è¨­å®šã™ã‚‹ã€‚READMEã«ä½¿ã„æ–¹ã¯å¤§ä½“æ›¸ã„ã¦ã‚ã‚‹ã€‚</p><h3 id=credentialã®æ›¸ãå‡ºã—>credentialã®æ›¸ãå‡ºã—</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>    - <span style=color:red>name</span>: copy credentials
      <span style=color:red>run</span>: echo ${GOOGLE_APPLICATION_CREDENTIALS_KEY} &gt; ${GOOGLE_APPLICATION_CREDENTIALS}
</code></pre></div><p><code>GOOGLE_APPLICATION_CREDENTIALS</code> ã§æŒ‡å®šã—ãŸãƒ‘ã‚¹ã«service accountã‚­ãƒ¼ã‚’æ›¸ãå‡ºã—ã¦ãŠãã€‚</p><h3 id=terraformã®å„ç¨®ãƒã‚§ãƒƒã‚¯ã¨planã®å®Ÿè¡Œ>terraformã®å„ç¨®ãƒã‚§ãƒƒã‚¯ã¨planã®å®Ÿè¡Œ</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>    - <span style=color:red>name</span>: init
      <span style=color:red>id</span>: init
      <span style=color:red>run</span>: terraform init
    - <span style=color:red>name</span>: validate
      <span style=color:red>id</span>: validate
      <span style=color:red>run</span>: terraform validate -no-color
      <span style=color:red>continue-on-error</span>: <span style=color:red>true</span>
    - <span style=color:red>name</span>: format check
      <span style=color:red>id</span>: fmt
      <span style=color:red>run</span>: terraform fmt -check -diff
      <span style=color:red>continue-on-error</span>: <span style=color:red>true</span>
    - <span style=color:red>name</span>: plan
      <span style=color:red>id</span>: plan
      <span style=color:red>run</span>: terraform plan -no-color
      <span style=color:red>continue-on-error</span>: <span style=color:red>true</span>
</code></pre></div><p>init/validate/fmt/planã‚’ãã‚Œãã‚Œå®Ÿè¡Œã—ã¦çµæœã‚’åé›†ã™ã‚‹ã€‚
validate/planã§ <code>-no-color</code> ã‚’ã¤ã‘å¿˜ã‚Œã‚‹ã¨å‡ºåŠ›ã«ã‚«ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ãŒå…¥ã‚Šè¾¼ã‚€ã®ã§æ³¨æ„ã€‚</p><p><code>continue-on-error: true</code> ã¨ã—ã¦ã„ã‚‹ã®ã¯å„ç¨®ãƒã‚§ãƒƒã‚¯ã®çµæœã‚’PRã«ã‚³ãƒ¡ãƒ³ãƒˆã¨ã—ã¦æ›¸ãå‡ºã™å‡¦ç†ã‚’è¡Œã†ãŸã‚ã€‚
ã“ã®è¨˜è¿°ã‚’çœãã¨ã„ãšã‚Œã‹ã®ãƒã‚§ãƒƒã‚¯ã§å¤±æ•—ã™ã‚‹ã¨ãã“ã§ä¸­æ–­ã™ã‚‹ã€‚
ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›¸ãå‡ºã™å¿…è¦ãŒãªã‘ã‚Œã°ãã†ã—ã¦ã—ã¾ãˆã°è‰¯ã„ã€‚</p><h3 id=å¤ã„ã‚³ãƒ¡ãƒ³ãƒˆã®å‰Šé™¤>å¤ã„ã‚³ãƒ¡ãƒ³ãƒˆã®å‰Šé™¤</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>    - <span style=color:red>name</span>: remove old comment
      <span style=color:red>id</span>: remove_old_comment
      <span style=color:red>uses</span>: actions/github-script@<span style=color:#f60>0.9.0</span>
      <span style=color:red>if</span>: github.event_name == <span style=color:#87ceeb>&#39;pull_request&#39;</span>
      <span style=color:red>with</span>:
        <span style=color:red>github-token</span>: ${{ secrets.GITHUB_TOKEN }}
        <span style=color:red>script</span>: <span style=color:#87ceeb>|
</span><span style=color:#87ceeb>          opts = github.issues.listComments.endpoint.merge({</span>
            <span style=color:red>owner</span>: context.repo.owner,
            <span style=color:red>repo</span>: context.repo.repo,
            <span style=color:red>issue_number</span>: context.issue.number,
            <span style=color:red>per_page</span>: <span style=color:#f60>100</span>,
          })
          const comments = await github.paginate(opts)
          for(const comment of comments) {
            if (comment.user.login === <span style=color:#87ceeb>&#34;github-actions[bot]&#34;</span> <span style=color:#e5e5e5>&amp;&amp;</span> comment.body.startsWith(<span style=color:#87ceeb>&#34;#### Terraform Format and Style&#34;</span>)) {
              github.issues.deleteComment({
                <span style=color:red>owner</span>: context.repo.owner,
                <span style=color:red>repo</span>: context.repo.repo,
                <span style=color:red>comment_id</span>: comment.id,
              })
            }
          }
</code></pre></div><p>ã“ã®actionã‚’è¤‡æ•°å›å®Ÿè¡Œã™ã‚‹ã¨éƒ½åº¦ã‚³ãƒ¡ãƒ³ãƒˆãŒå¢—ãˆã¦ã—ã¾ã†ã®ã§ã€
<a href=https://github.com/actions/github-script>github-script</a>ã‚’ç”¨ã„ã¦å¤ã„ã‚³ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤ã™ã‚‹ã€‚
é€šå¸¸ãã‚“ãªã«ãŸãã•ã‚“ã‚³ãƒ¡ãƒ³ãƒˆãŒä»˜ãã“ã¨ã¯ç„¡ã„ã¨æ€ã†ãŒã€
å¿µã®ç‚ºãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã—ã¦å…¨éƒ¨ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’å–ã‚Šå‡ºã—ã¦ã€github actionsã‹ã‚‰ã¤ã‘ã‚‰ã‚ŒãŸã‚³ãƒ¡ãƒ³ãƒˆã‹ã¤æœ¬æ–‡ãŒã“ã®actionã§ä»˜ä¸ã—ãŸã‚‚ã®ã¨é¡ä¼¼ã™ã‚‹ã‚‚ã®ã‚’å‰Šé™¤ã—ã¦ã„ã‚‹ã€‚</p><p>github-scriptã®ä½¿ã„æ–¹ã¯ã“ã®ã‚ãŸã‚Šã‚’å‚è€ƒã«ã—ãŸã€‚</p><ul><li><a href=https://github.com/actions/github-script#welcome-a-first-time-contributor>https://github.com/actions/github-script#welcome-a-first-time-contributor</a></li><li><a href=https://octokit.github.io/rest.js/>https://octokit.github.io/rest.js/</a></li><li><a href=https://maku.blog/p/7r6gr3d/>https://maku.blog/p/7r6gr3d/</a></li></ul><h3 id=ãƒã‚§ãƒƒã‚¯planã®çµæœã‚’ã‚³ãƒ¡ãƒ³ãƒˆã¨ã—ã¦æ›¸ãå‡ºã™>ãƒã‚§ãƒƒã‚¯ã€planã®çµæœã‚’ã‚³ãƒ¡ãƒ³ãƒˆã¨ã—ã¦æ›¸ãå‡ºã™</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>    - <span style=color:red>name</span>: show plan
      <span style=color:red>uses</span>: actions/github-script@<span style=color:#f60>0.9.0</span>
      <span style=color:red>if</span>: github.event_name == <span style=color:#87ceeb>&#39;pull_request&#39;</span>
      <span style=color:red>env</span>:
        <span style=color:red>PLAN</span>: <span style=color:#87ceeb>&#34;terraform\n${{ steps.plan.outputs.stdout }}&#34;</span>
      <span style=color:red>with</span>:
        <span style=color:red>github-token</span>: ${{ secrets.GITHUB_TOKEN }}
        <span style=color:red>script</span>: <span style=color:#87ceeb>|
</span><span style=color:#87ceeb>          const output = `#### Terraform Format and Style ğŸ–Œ\`${{ steps.fmt.outcome }}\`</span>
          <span style=color:#0f0>#### Terraform Initialization: \`${{ steps.init.outcome }}\`</span>
          <span style=color:#0f0>#### Terraform Validation: ${{ steps.validate.outputs.stdout }}</span>
          <span style=color:#0f0>#### Terraform Format: ${{ steps.fmt.outputs.stdout }} </span>
          <span style=color:#0f0>#### Terraform Plan: \`${{ steps.plan.outcome }}\`</span>
          &lt;details&gt;&lt;summary&gt;Show Plan&lt;/summary<span style=color:#87ceeb>&gt;
</span><span style=color:#87ceeb>          \`\`\`${process.env.PLAN}\`\`\`</span>
          &lt;/details<span style=color:#87ceeb>&gt;
</span><span style=color:#87ceeb>          *Pusher: @${{ github.actor }}, Action: \`${{ github.event_name }}\`,  Workflow: \`${{ github.workflow }}\`*`;</span>
          github.issues.createComment({
            <span style=color:red>issue_number</span>: context.issue.number,
            <span style=color:red>owner</span>: context.repo.owner,
            <span style=color:red>repo</span>: context.repo.repo,
            <span style=color:red>body</span>: output
          })
</code></pre></div><p>é©å½“ãªãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã§PRã«ã‚³ãƒ¡ãƒ³ãƒˆã¨ã—ã¦çµæœã‚’æ›¸ãå‡ºã™ã€‚
å½“ç„¶ãªãŒã‚‰æ›¸ãå‡ºã™å…ˆã®PRãŒç„¡ã„ã¨å‹•ã‹ãªã„ã®ã§ã€<code>if</code>ã§event_nameã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦pull_requestã ã‘ã‚’å¯¾è±¡ã«ã™ã‚‹ã€‚</p><h3 id=ãƒã‚§ãƒƒã‚¯planã«ä¸å‚™ãŒã‚ã‚‹å ´åˆã¯ã‚¨ãƒ©ãƒ¼çµ‚äº†ã•ã›ã‚‹>ãƒã‚§ãƒƒã‚¯ã€planã«ä¸å‚™ãŒã‚ã‚‹å ´åˆã¯ã‚¨ãƒ©ãƒ¼çµ‚äº†ã•ã›ã‚‹</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>- <span style=color:red>name</span>: check on failure
      <span style=color:red>if</span>: steps.validate.outcome == <span style=color:#87ceeb>&#39;failure&#39;</span> || steps.fmt.outcome == <span style=color:#87ceeb>&#39;failure&#39;</span> || steps.plan.outcome == <span style=color:#87ceeb>&#39;failure&#39;</span>
      <span style=color:red>run</span>: exit <span style=color:#f60>1</span>
</code></pre></div><p>ä¸å‚™ãŒã‚ã‚‹å ´åˆã¯ãƒãƒ¼ã‚¸ã§ããªã„ã‚ˆã†ã«ã—ãŸã„ã®ã§ã€çµ‚äº†ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ãã‚Œãã‚Œãƒã‚§ãƒƒã‚¯ã—ã¦ã©ã‚Œã‹ä¸€ã¤ã§ã‚‚å¤±æ•—ã—ã¦ã„ãŸã‚‰ã‚¨ãƒ©ãƒ¼çµ‚äº†ã•ã›ã‚‹ã€‚</p><h3 id=terraform-applyã™ã‚‹>terraform applyã™ã‚‹</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>    - <span style=color:red>name</span>: apply
      <span style=color:red>if</span>: github.ref == <span style=color:#87ceeb>&#39;refs/heads/master&#39;</span> <span style=color:#e5e5e5>&amp;&amp;</span> github.event_name == <span style=color:#87ceeb>&#39;push&#39;</span>
      <span style=color:red>run</span>: terraform apply -auto-approve
</code></pre></div><p>ç„¡äº‹ã«masterã«ãƒãƒ¼ã‚¸ã•ã‚ŒãŸã‚‰applyã—ã¦å¤‰æ›´å†…å®¹ã‚’ã‚¤ãƒ³ãƒ•ãƒ©ã«åæ˜ ã•ã›ã‚‹ã€‚
å®Ÿè¡Œç¢ºèªãŒå‡ºãªã„ã‚ˆã†ã« <code>-auto-approve</code> ã‚’ã¤ã‘ã¦å®Ÿè¡Œã™ã‚‹ã€‚</p></div><div class=post-info><div class=post-date>2020-07-19</div><div class=post-taxonomies></div></div></article><div class="pagination post-pagination"><div class="left pagination-item"><a href=/posts/661465923/>[ãƒ¡ãƒ¢]BigQueryã‚’DataGripã‹ã‚‰ä½¿ç”¨ã™ã‚‹</a></div><div class="right pagination-item"><a href=/posts/629278766/>Kubernetesã®envã¯å¾Œå‹ã¡</a></div></div></main><footer class=common-footer><div class=copyright><p>Â© ques0942, 2020<br>Powered by <a target=_blank rel="noopener noreferrer" href=https://gohugo.io/>Hugo</a>, theme <a target=_blank rel="noopener noreferrer" href=https://github.com/mitrichius/hugo-theme-anubis>Anubis</a>.</p></div></footer></div></body></html>