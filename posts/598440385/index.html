<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en-us lang=en-us><head><link href=https://gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta name=generator content="Hugo 0.62.0"><meta name=viewport content="width=device-width,initial-scale=1"><title>[Kubernetes]HPA使用時のreplicasの設定 &#183; 常にいまいち</title><meta name=description content><link type=text/css rel=stylesheet href=https://blog.app.melvins-nest.com/css/print.css media=print><link type=text/css rel=stylesheet href=https://blog.app.melvins-nest.com/css/poole.css><link type=text/css rel=stylesheet href=https://blog.app.melvins-nest.com/css/syntax.css><link type=text/css rel=stylesheet href=https://blog.app.melvins-nest.com/css/hyde.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700"><link rel=apple-touch-icon-precomposed sizes=144x144 href=/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/favicon.png></head><body><aside class=sidebar><div class="container sidebar-sticky"><div class=sidebar-about><a href=https://blog.app.melvins-nest.com/><h1>常にいまいち</h1></a><p class=lead>blog for something</p></div><nav><ul class=sidebar-nav><li><a href=https://blog.app.melvins-nest.com/>Home</a></li></ul></nav><p>&copy; 2020. All rights reserved.</p></div></aside><main class="content container"><div class=post><h1>[Kubernetes]HPA使用時のreplicasの設定</h1><time datetime=2020-04-16T17:06:48Z class=post-date>Thu, Apr 16, 2020</time><p>DeploymentとHorizontalPodAutoscaler(HPA)の組み合わせでハマった箇所があったため、検証結果と検証用の資料をまとめた。</p><h2 id=heading>検証環境</h2><ul><li>Kubernetes version: 1.14.10-gke.27</li><li>検証資料: <a href=https://github.com/ques0942/k8s-hpa-sample>https://github.com/ques0942/k8s-hpa-sample</a></li></ul><h2 id=heading-1>結論</h2><ul><li>HPA使用時はDeploymentにreplicasを設定しないほうが良い</li><li>replicasありのDeploymentに後からHPAを適用したい場合<ul><li>replicas無しのDeploymentをapplyすると一時的にPodは1つになる</li><li><code>kubectl apply edit-last-applied deployment ${target}</code> でDeploymentからreplicasを削除できる</li></ul></li><li>HPAでスケールアウトした後HPAを削除してもPod数はそのまま</li><li>最後にapplyしたDeploymentがreplicasを持たない場合、kubectl editでreplicasを書き換えたとしてもその後replicas無しのDeploymentをapplyしてもPod数は1にならない<ul><li>詳細は後述するが<a href=https://kubernetes.io/docs/tasks/manage-kubernetes-objects/declarative-config/#merge-patch-calculation>kubectl applyの差分計算ロジック</a>による挙動</li></ul></li></ul><h2 id=heading-2>説明</h2><p>Deploymentに紐づくPodの数は <code>replicas</code> に設定された数字と等しくなるが <code>replicas</code> が未設定の場合は1になる。
一方でHorizontal Pod Autoscaler(HPA)を使用すると、Deploymentの <code>replicas</code> は負荷状況に合わせて自動で変更される。では以下のようなユースケースの場合どのような挙動となるだろうか?</p><h3 id=httpsgithubcomques0942k8s-hpa-sampleblobc7bfef85c0a3c6a9306ecc915c706217a20cd041readmemdcase1-e981a9e794a8e6b888e381bfe381aedeploymente381abreplicase38292e6988ee7a4bae38197e3819fdeploymente38292applye38199e3828b><a href=https://github.com/ques0942/k8s-hpa-sample/blob/c7bfef85c0a3c6a9306ecc915c706217a20cd041/README.md#case1-%E9%81%A9%E7%94%A8%E6%B8%88%E3%81%BF%E3%81%AEdeployment%E3%81%ABreplicas%E3%82%92%E6%98%8E%E7%A4%BA%E3%81%97%E3%81%9Fdeployment%E3%82%92apply%E3%81%99%E3%82%8B>手順</a></h3><ol><li>replicas = 3としてDeploymentを適用する</li><li>HPAを有効化する</li><li>HPAでreplicasが10に増加した</li><li>1で適用したDeploymentを修正して適用したが、その時replicasは3のままだった</li></ol><h3 id=heading-3>問題</h3><p>この手順を踏むと4の実施後にreplicasは3に戻ってしまう。
規模が大きくなってくるとデプロイ時に縮退することになるため望ましくない挙動だろう。</p><h3 id=heading-4>対策</h3><ol><li>最後にapplyされたDeploymentを開いてreplicasを削除する<ul><li><code>kubectl apply edit-last-applied deployment ${target}</code> を使う</li></ul></li><li>以降applyするDeploymentにはreplicasを含めない</li></ol><p>単純にreplicasを含まないDeploymentをapplyすると、<a href=https://github.com/ques0942/k8s-hpa-sample/blob/c7bfef85c0a3c6a9306ecc915c706217a20cd041/README.md#case2-replicas%E3%82%92%E6%98%8E%E7%A4%BA%E3%81%97%E3%81%9Fdeployment%E3%81%ABreplicas%E3%82%92%E6%8C%81%E3%81%9F%E3%81%AA%E3%81%84deployment%E3%82%92apply%E3%81%99%E3%82%8B>一時的にPod数は1になる</a>ため注意。</p><h3 id=1-replicasdeploymentkubectl-edit>疑問点1: replicasが無いDeploymentをkubectl editしたらどうなる?</h3><p>replicasありのDeploymentの後にreplicas無しのDeploymentをapplyすると、replicasは一時的に1になり縮退を起こしてしまう。
では、replicas無しのDeploymentをapplyした後にkubectl editでreplicasを書き換えた場合、replicasありのDeploymentをapplyした状態と同じになるのだろうか?
トラブルシュート中にkubectl editでreplicasを修正して急場を凌いだが、後日リリース時に縮退が起こって死というのは避けたいシナリオである。
<a href=https://github.com/ques0942/k8s-hpa-sample/blob/c7bfef85c0a3c6a9306ecc915c706217a20cd041/README.md#case5-replicas%E3%81%AE%E7%84%A1%E3%81%84deployment%E3%82%92%E7%9B%B4%E6%8E%A5%E4%BF%AE%E6%AD%A3%E3%81%97%E3%81%A6replicas%E3%82%92%E6%8C%87%E5%AE%9A%E5%BE%8Creplicas%E3%81%AE%E7%84%A1%E3%81%84deployment%E3%82%92apply%E3%81%99%E3%82%8B>実際に検証を行った</a>が、嬉しいことにkubectl editで直接修正した場合はreplicas無しのDeploymentと同じ挙動となった。
これは<a href=https://kubernetes.io/docs/tasks/manage-kubernetes-objects/declarative-config/#merge-patch-calculation>kubectl apply</a>の差分計算ロジックを考えると納得できる。
kubectl applyの対象となったリソースには<code>last-applied-configuration</code> というアノテーションで最後にapplyされたマニフェストが保存され、それと現在のリソースの状態、applyされるマニフェストから以下の内容で変更差分が構築される。</p><ol><li>last-applied-configurationに存在し、マニフェストに無いフィールドを削除対象とする</li><li>マニフェストに存在し、現在のリソースに含まれない/値が一致しないフィールドを追加/更新する</li></ol><p>今回のreplicasにおいては、last-applied-configurationにもマニフェストにも存在しないため、変更対象にならなかったわけである。</p><h3 id=2-hpa>疑問点2: スケールアウト後にHPAを削除した場合どうなる?</h3><p>スケールアウト後にHPAを削除してしまった場合Pod数はどうなるのだろうか。
これは単純でlast-applied Deploymentが<a href=https://github.com/ques0942/k8s-hpa-sample/blob/c7bfef85c0a3c6a9306ecc915c706217a20cd041/README.md#case6-replicas%E3%81%82%E3%82%8A%E3%81%AEdeployment%E3%81%8Chpa%E3%81%A7%E6%9C%80%E5%A4%A7%E3%81%BE%E3%81%A7%E3%82%B9%E3%82%B1%E3%83%BC%E3%83%AB%E3%82%A2%E3%82%A6%E3%83%88%E3%81%97%E3%81%9F%E7%8A%B6%E6%85%8B%E3%81%A7hpa%E3%82%92%E5%89%8A%E9%99%A4%E3%81%99%E3%82%8B>replicasあり</a>でも、<a href=https://github.com/ques0942/k8s-hpa-sample/blob/c7bfef85c0a3c6a9306ecc915c706217a20cd041/README.md#case7-replicas%E7%84%A1%E3%81%97%E3%81%AEdeployment%E3%81%8Chpa%E3%81%A7%E6%9C%80%E5%A4%A7%E3%81%BE%E3%81%A7%E3%82%B9%E3%82%B1%E3%83%BC%E3%83%AB%E3%82%A2%E3%82%A6%E3%83%88%E3%81%97%E3%81%9F%E7%8A%B6%E6%85%8B%E3%81%A7hpa%E3%82%92%E5%89%8A%E9%99%A4%E3%81%99%E3%82%8B>replicas無し</a>でもPod数は現在の数をキープする。
誤って削除してしまったとしても、Pod数が足りなくなる前に再度作成しなおせば問題はない。</p></div></main><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-155249985-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></body></html>