<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en-us lang=en-us><head><link href=https://gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta name=generator content="Hugo 0.62.0"><meta name=viewport content="width=device-width,initial-scale=1"><title>[Kubernetes]HPA使用時のreplicasの設定 &#183; 常にいまいち</title><meta name=description content><link type=text/css rel=stylesheet href=/css/print.css media=print><link type=text/css rel=stylesheet href=/css/poole.css><link type=text/css rel=stylesheet href=/css/syntax.css><link type=text/css rel=stylesheet href=/css/hyde.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700"><link rel=apple-touch-icon-precomposed sizes=144x144 href=/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/favicon.png></head><body><aside class=sidebar><div class="container sidebar-sticky"><div class=sidebar-about><a href=/><h1>常にいまいち</h1></a><p class=lead>blog for something</p></div><nav><ul class=sidebar-nav><li><a href=/>Home</a></li></ul></nav><p>&copy; 2020. All rights reserved.</p></div></aside><main class="content container"><div class=post><h1>[Kubernetes]HPA使用時のreplicasの設定</h1><time datetime=2020-04-12T08:54:14Z class=post-date>Sun, Apr 12, 2020</time><p>Deploymentに紐づくPodの数は <code>replicas</code> に設定された数字と等しくなる。 <code>replicas</code> が未設定の場合は1になる。
一方でHorizontal Pod Autoscaler(HPA)を使用すると、Deploymentの <code>replicas</code> は負荷状況に合わせて自動で変更される。では以下のようなユースケースの場合どのような挙動となるだろうか?</p><ol><li>replicas = 3としてDeploymentを適用する</li><li>HPAを有効化する</li><li>HPAでreplicasが10に増加した</li><li>1で適用したDeploymentを修正して適用したが、その時replicasを3のままだった</li></ol><p>この手順を踏むと4の実施後にreplicasは3に戻ってしまう。
Spinnakerなどを使ってデプロイフローを組んでいてHPAを導入するようなケースではこのようになってしまう。
規模が大きくなってくるとこの挙動はデプロイ時に縮退するため望ましくない挙動だろう。
この記事ではこれの対策を考えてみる。</p><ol><li>既に適用済みのDeploymentを修正してreplicasを外す</li><li>replicasをピークタイムのサイズに合わせて設定する</li></ol><p>そもそもHPAを使わないのであれば最初からreplicasを設定しないのがベストだろう。</p></div></main><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-155249985-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></body></html>